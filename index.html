<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZAC-MAN: Operations Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --zalando-orange: #ff6900;
            --zalando-black: #1a1a1a;
            --neon-blue: #00ffff;
            --text-main: #ffffff;
            --sidebar-bg: #222;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--zalando-black);
            color: var(--text-main);
            /* APPLICO FONT ARCADE OVUNQUE */
            font-family: 'Press Start 2P', cursive; 
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 12px; /* Base size ridotto per leggibilità font pixel */
        }

        /* --- LAYOUT --- */
        #main-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* SIDEBAR (ISTRUZIONI & INFO) */
        #sidebar {
            width: 380px; /* Leggermente più larga per il font pixel */
            background-color: var(--sidebar-bg);
            border-right: 4px solid var(--zalando-orange);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            z-index: 100;
            line-height: 1.8; /* Maggiore interlinea per font pixel */
        }

        #game-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #000;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* TYPOGRAPHY SIDEBAR */
        h1 {
            color: var(--zalando-orange);
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 3px 3px #000;
            line-height: 1.4;
        }
        .subtitle {
            font-size: 0.6rem;
            color: #888;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }

        h2 { 
            font-size: 0.8rem; 
            color: var(--neon-blue); 
            margin-top: 20px; 
            margin-bottom: 15px;
            border-bottom: 2px dashed #444; 
            padding-bottom: 10px;
            line-height: 1.5;
        }
        
        p, li { 
            font-size: 0.6rem; /* Ridotto per stare nel box */
            color: #ccc; 
            margin-bottom: 15px; 
            text-align: justify;
        }
        strong { color: white; color: var(--zalando-orange); }
        
        .info-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border: 2px solid #444; /* Bordo pixelato invece che left-bar */
            margin-bottom: 20px;
            box-shadow: 3px 3px 0px #000;
        }

        /* NAVIGAZIONE ORIZZONTALE */
        .controls-nav {
            margin-top: auto;
            display: flex;
            flex-direction: row; /* FORZA ORIZZONTALE */
            gap: 10px;
            width: 100%;
            align-items: center;
            padding-top: 20px;
            border-top: 2px dashed #444;
        }

        button {
            background: #444;
            color: white;
            border: 2px solid #888;
            padding: 12px 10px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            flex: 1; /* Distribuisce spazio equamente */
            transition: all 0.1s;
            box-shadow: 0 4px 0 #222;
            text-align: center;
            line-height: 1.4;
        }
        button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #222;
        }
        
        button:hover { 
            background: #666; 
            border-color: #aaa; 
        }
        
        /* TASTI ARANCIONI (Primary) */
        button.primary { 
            background: var(--zalando-orange); 
            color: black; 
            border-color: #ff9933;
            box-shadow: 0 4px 0 #994000;
        }
        button.primary:hover {
            background: #ff8533;
        }
        button.primary:active {
            box-shadow: 0 0 0 #994000;
        }


        /* ARCADE CABINET STYLE */
        #arcade-screen {
            position: relative;
            border: 10px solid #333;
            border-radius: 4px; /* Meno round per look pixel */
            box-shadow: 0 0 40px rgba(255, 105, 0, 0.2);
            background: black;
            overflow: hidden;
            /* Aspect ratio fix */
            width: 600px;
            height: 600px;
            max-width: 95vw;
            max-height: 95vw;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* GAME OVERLAYS */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 30px;
            z-index: 10;
        }
        .hidden { display: none !important; }

        .overlay h2 { 
            font-size: 1.2rem; 
            color: var(--neon-blue); 
            margin-bottom: 30px; 
            line-height: 1.6;
            text-shadow: 2px 2px var(--zalando-orange);
        }
        
        /* Box Lezioni - Centrato ma con testo spostato a dx */
        .lesson-box {
            border: 4px double white; 
            padding: 20px 20px 20px 40px; /* Più padding a sinistra */
            margin: 20px 0; 
            background: #111;
            width: 90%;
            text-align: left; /* Testo a bandiera a sx */
            line-height: 1.8;
            font-size: 0.6rem;
            color: #ddd;
        }

        .overlay p { 
            font-size: 0.7rem; 
            color: #fff; 
            max-width: 90%; 
            line-height: 1.8; 
            margin-bottom: 20px;
        }
        
        /* Pulsanti Overlay Orizzontali Larghi */
        .overlay button.primary {
            width: auto;
            min-width: 200px; /* Belli larghi */
            font-size: 0.8rem;
            padding: 15px;
            margin-top: 20px;
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            #main-wrapper { flex-direction: column-reverse; }
            #sidebar { width: 100%; height: 40%; border-right: none; border-top: 4px solid var(--zalando-orange); }
            #game-area { height: 60%; }
        }

        /* MOBILE CONTROLS */
        #mobile-controls {
            position: absolute; bottom: 20px; right: 20px;
            display: none; flex-direction: column; align-items: center; gap: 10px; z-index: 50;
        }
        .d-row { display: flex; gap: 60px; }
        .d-btn {
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.1);
            border: 4px solid rgba(255,255,255,0.3); 
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white; user-select: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
        }
        .d-btn:active { background: var(--zalando-orange); transform: translateY(4px); box-shadow: none; }

    </style>
</head>
<body>

<div id="main-wrapper">
    
    <!-- SIDEBAR: INFORMAZIONI E CONTROLLI -->
    <div id="sidebar">
        <h1>ZAC-MAN</h1>
        <div class="subtitle">OPERATIONS EDITION</div>

        <!-- SEZIONE 1: COS'È NOTEBOOKLM -->
        <div class="info-box">
            <h2>Cos'e' NotebookLM?</h2>
            <p><strong>NOTE:</strong> Non e' un plugin. E' una Web App esterna.</p>
            <p>E' il tuo <strong>Research Assistant</strong>. Carica PDF, Slide o Link e lui diventa un esperto istantaneo.</p>
            <p style="font-size:0.5rem; color:#666; margin-top:10px;">URL: notebooklm.google.com</p>
        </div>

        <!-- SEZIONE 2: MISSIONE -->
        <div class="info-box">
            <h2>Missione</h2>
            <p>Il Drive e' pieno di <strong>Fantasmi</strong> (Documenti).</p>
            <ul>
                <li>Usa le Frecce.</li>
                <li>Mangia le Fonti (PDF, DOC).</li>
                <li>Sblocca le Features.</li>
            </ul>
        </div>

        <!-- NAVIGAZIONE -->
        <div class="controls-nav">
            <button onclick="prevLevel()">&lt; PREV</button>
            <button onclick="resetGame()">RESET</button>
            <button class="primary" onclick="window.open('https://notebooklm.google.com', '_blank')">OPEN APP &gt;</button>
        </div>
    </div>

    <!-- AREA GIOCO -->
    <div id="game-area">
        <div id="arcade-screen">
            <canvas id="gameCanvas" width="600" height="600"></canvas>
            
            <!-- START SCREEN -->
            <div id="start-screen" class="overlay">
                <h2 style="color:var(--zalando-orange);">START GAME</h2>
                <div style="margin:20px;">
                     <!-- Zally Placeholder -->
                     <img src="zally.png" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iI2ZmNjkwMCIvPjwvc3ZnPg=='" style="width: 80px; height: 80px; animation: bounce 1s infinite alternate;">
                </div>
                <p>PREMI START PER INIZIARE</p>
                <button class="primary" onclick="startGame()">START</button>
            </div>

            <!-- LEVEL COMPLETE SCREEN -->
            <div id="level-screen" class="overlay hidden">
                <h2 id="level-title">LEVEL CLEARED!</h2>
                <p id="level-msg">...</p>
                
                <div class="lesson-box">
                    <p id="level-lesson" style="color: #00ffff; margin:0;">...</p>
                </div>
                
                <button class="primary" onclick="nextLevel()">NEXT FEATURE &gt;&gt;</button>
            </div>

            <!-- VICTORY SCREEN -->
            <div id="victory-screen" class="overlay hidden">
                <h2 style="color: var(--zalando-orange);">MISSION COMPLETED!</h2>
                <p>CAOS OPERATIVO DOMATO.</p>
                <div class="lesson-box" style="border-color: var(--zalando-orange);">
                    <p>RECAP:</p>
                    <p>1. CENTRALIZZA (Sources)</p>
                    <p>2. SINTETIZZA (Summary)</p>
                    <p>3. VERIFICA (Grounding)</p>
                </div>
                <button class="primary" onclick="resetGame()">GIOCA ANCORA</button>
            </div>

            <!-- TOUCH CONTROLS -->
            <div id="mobile-controls">
                <div class="d-btn" ontouchstart="handleTouch('up')">▲</div>
                <div class="d-row">
                    <div class="d-btn" ontouchstart="handleTouch('left')">◀</div>
                    <div class="d-btn" ontouchstart="handleTouch('right')">▶</div>
                </div>
                <div class="d-btn" ontouchstart="handleTouch('down')">▼</div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ZAC-MAN ENGINE - PIXEL PERFECT EDITION
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let animationId;

// --- CONFIG ---
const COLS = 20;
const ROWS = 20;
let tileSize = 30; // Dynamic resizing will handle this

// --- STATE ---
let gameState = 'start'; 
let currentLevel = 1;
let ghosts = [];
let player = { x: 1, y: 1, dirX: 0, dirY: 0, nextDirX: 0, nextDirY: 0, speed: 0.15, angle: 0 };

// --- MAPPA (1=Muro, 0=Vuoto) ---
const mapDesign = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,1,0,1,1,0,1,0,1,1,0,1,1,1,0,0,1],
    [1,0,1,1,1,0,1,1,0,1,0,1,1,0,1,1,1,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,0,1,1,1,1,1,1,0,1,0,1,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,0,0,0,1],
    [1,1,1,1,0,1,1,1,0,1,0,1,1,1,1,0,1,1,1,1],
    [1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,1],
    [1,0,1,1,0,1,0,1,1,0,0,1,0,1,0,1,1,0,0,1], 
    [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,0,1,1,1,1,1,1,0,1,0,1,1,0,1],
    [1,0,0,1,0,1,0,0,0,1,0,0,0,0,1,0,1,0,0,1],
    [1,1,0,1,0,1,1,1,0,1,0,1,1,1,1,0,1,0,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,1,0,1,1,0,1,0,1,1,0,1,1,1,0,0,1],
    [1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],
    [1,1,1,0,1,0,1,1,1,1,1,1,1,0,1,0,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const GHOST_TYPES = [
    { name: "PDF", color: "#e74c3c", label: "PDF" },
    { name: "DOC", color: "#3498db", label: "DOC" },
    { name: "WEB", color: "#2ecc71", label: "WEB" },
    { name: "MAIL", color: "#f1c40f", label: "@" }
];

// --- INIT ---
function init() {
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); // Initial call
    requestAnimationFrame(gameLoop);
    
    // Check mobile
    if('ontouchstart' in window) {
        document.getElementById('mobile-controls').style.display = 'flex';
    }
}

function resizeCanvas() {
    // Keep internal resolution consistent but allow CSS to scale
    // Canvas resolution is 600x600 as defined in HTML
    const container = document.getElementById('arcade-screen');
    // Ensure container is square-ish
    // let size = Math.min(container.clientWidth, container.clientHeight);
    // container.style.height = size + 'px'; // Enforce square aspect via CSS if needed
}

function initLevel(level) {
    player.x = 1; player.y = 1;
    player.dirX = 0; player.dirY = 0;
    player.nextDirX = 0; player.nextDirY = 0;

    ghosts = [];
    let count = 2 + level; 
    
    for (let i = 0; i < count; i++) {
        spawnGhost(i);
    }
}

function spawnGhost(index) {
    let placed = false;
    while (!placed) {
        let rx = Math.floor(Math.random() * COLS);
        let ry = Math.floor(Math.random() * ROWS);
        if (mapDesign[ry][rx] === 0 && (Math.abs(rx - player.x) > 6)) {
            let type = GHOST_TYPES[index % GHOST_TYPES.length];
            let dirs = [{x:1,y:0}, {x:-1,y:0}, {x:0,y:1}, {x:0,y:-1}];
            let startDir = dirs[Math.floor(Math.random()*4)];
            
            ghosts.push({
                x: rx, 
                y: ry, 
                type: type,
                dirX: startDir.x,
                dirY: startDir.y,
                speed: 0.08, 
                lastMoveTime: 0
            });
            placed = true;
        }
    }
}

// --- LOGIC ---
function isWall(x, y) {
    if (y < 0 || y >= ROWS || x < 0 || x >= COLS) return true;
    return mapDesign[Math.floor(y)][Math.floor(x)] === 1;
}

function update() {
    if (gameState !== 'playing') return;

    // 1. PLAYER MOVEMENT
    const centerX = Math.floor(player.x + 0.5);
    const centerY = Math.floor(player.y + 0.5);
    const dist = Math.abs(player.x - centerX) + Math.abs(player.y - centerY);

    if (dist < 0.15) { 
        if (player.nextDirX !== 0 || player.nextDirY !== 0) {
            if (!isWall(centerX + player.nextDirX, centerY + player.nextDirY)) {
                player.x = centerX; player.y = centerY;
                player.dirX = player.nextDirX; player.dirY = player.nextDirY;
                player.nextDirX = 0; player.nextDirY = 0;
            }
        }
        if (isWall(centerX + player.dirX, centerY + player.dirY)) {
            player.dirX = 0; player.dirY = 0;
        }
    }
    player.x += player.dirX * player.speed;
    player.y += player.dirY * player.speed;
    
    if (player.dirX === 1) player.angle = 0;
    if (player.dirX === -1) player.angle = Math.PI;
    if (player.dirY === -1) player.angle = -Math.PI/2;
    if (player.dirY === 1) player.angle = Math.PI/2;

    // 2. GHOST AI MOVEMENT
    ghosts.forEach(ghost => {
        const gx = Math.floor(ghost.x + 0.5);
        const gy = Math.floor(ghost.y + 0.5);
        const gDist = Math.abs(ghost.x - gx) + Math.abs(ghost.y - gy);

        if (gDist < 0.1) {
            ghost.x = gx; ghost.y = gy;
            let nextX = Math.round(ghost.x + ghost.dirX);
            let nextY = Math.round(ghost.y + ghost.dirY);
            
            if (isWall(nextX, nextY) || Math.random() < 0.1) {
                let possible = [];
                if (!isWall(gx+1, gy)) possible.push({x:1, y:0});
                if (!isWall(gx-1, gy)) possible.push({x:-1, y:0});
                if (!isWall(gx, gy+1)) possible.push({x:0, y:1});
                if (!isWall(gx, gy-1)) possible.push({x:0, y:-1});
                
                let forward = possible.filter(d => !(d.x === -ghost.dirX && d.y === -ghost.dirY));
                
                if (forward.length > 0) {
                    let pick = forward[Math.floor(Math.random() * forward.length)];
                    ghost.dirX = pick.x; ghost.dirY = pick.y;
                } else if (possible.length > 0) {
                    let pick = possible[0];
                    ghost.dirX = pick.x; ghost.dirY = pick.y;
                }
            }
        }
        ghost.x += ghost.dirX * ghost.speed;
        ghost.y += ghost.dirY * ghost.speed;
    });

    // 3. EATING
    for (let i = ghosts.length - 1; i >= 0; i--) {
        const g = ghosts[i];
        const dx = player.x - g.x;
        const dy = player.y - g.y;
        if (Math.sqrt(dx*dx + dy*dy) < 0.8) {
            ghosts.splice(i, 1);
        }
    }

    if (ghosts.length === 0) endLevel();
}

// --- DRAW ---
function draw() {
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    const ts = canvas.width / COLS;

    // Map
    ctx.fillStyle = "#2c3e50";
    for (let y=0; y<ROWS; y++) {
        for (let x=0; x<COLS; x++) {
            if (mapDesign[y][x] === 1) {
                ctx.fillStyle = "#333";
                ctx.fillRect(x*ts, y*ts, ts, ts);
                ctx.strokeStyle = "var(--zalando-orange)";
                ctx.lineWidth = 1;
                ctx.strokeRect(x*ts+4, y*ts+4, ts-8, ts-8);
            }
        }
    }

    // Ghosts
    ghosts.forEach(g => {
        let gx = g.x * ts + ts/2;
        let gy = g.y * ts + ts/2;
        ctx.fillStyle = g.type.color;
        ctx.beginPath();
        ctx.arc(gx, gy-2, ts*0.4, Math.PI, 0, false);
        ctx.lineTo(gx+ts*0.4, gy+ts*0.4);
        ctx.lineTo(gx-ts*0.4, gy+ts*0.4);
        ctx.fill();
        ctx.fillStyle = "black";
        ctx.font = "bold 10px Arial";
        ctx.textAlign = "center";
        ctx.fillText(g.type.label, gx, gy+4);
    });

    // Player
    let px = player.x * ts + ts/2;
    let py = player.y * ts + ts/2;
    ctx.save();
    ctx.translate(px, py);
    ctx.rotate(player.angle);
    ctx.fillStyle = "#ff6900";
    ctx.beginPath();
    let mouth = Math.abs(Math.sin(Date.now()/100)) * 0.2 + 0.05;
    ctx.arc(0, 0, ts*0.45, mouth*Math.PI, (2-mouth)*Math.PI);
    ctx.lineTo(0,0);
    ctx.fill();
    ctx.restore();
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// --- UI CONTROL ---
function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    currentLevel = 1;
    gameState = 'playing';
    initLevel(1);
}

function resetGame() {
    document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    document.getElementById('start-screen').classList.remove('hidden');
    gameState = 'start';
}

function prevLevel() {
    if (currentLevel > 1) {
        currentLevel--;
        document.getElementById('level-screen').classList.add('hidden');
        document.getElementById('victory-screen').classList.add('hidden');
        gameState = 'playing';
        initLevel(currentLevel);
    } else {
        resetGame();
    }
}

function endLevel() {
    gameState = 'level_transition';
    const screen = document.getElementById('level-screen');
    const title = document.getElementById('level-title');
    const msg = document.getElementById('level-msg');
    const lesson = document.getElementById('level-lesson');

    screen.classList.remove('hidden');

    if (currentLevel === 1) {
        title.innerHTML = "FONTI CARICATE!";
        msg.innerHTML = "Hai centralizzato la conoscenza.";
        lesson.innerHTML = "<strong>FEATURE: SORGENTI MULTIMODALI</strong><br><br>Invece di avere 10 tab aperti (Drive, Slide, PDF), caricali tutti su NotebookLM. Diventa la tua 'Single Source of Truth'.";
    } else if (currentLevel === 2) {
        title.innerHTML = "SINTESI FATTA!";
        msg.innerHTML = "Hai ridotto il rumore di fondo.";
        lesson.innerHTML = "<strong>FEATURE: SOMMARIO & KEY TOPICS</strong><br><br>NotebookLM legge istantaneamente documenti di 50 pagine e ti dice cosa conta. Ottimo per Onboarding e nuove Policy.";
    } else if (currentLevel === 3) {
        title.innerHTML = "GROUNDING OK!";
        msg.innerHTML = "Niente allucinazioni, solo fatti.";
        lesson.innerHTML = "<strong>FEATURE: CITAZIONI IN-LINE</strong><br><br>Ogni risposta ha un link [1] che ti porta alla riga esatta del documento originale. Fiducia totale nel dato.";
    }
}

function nextLevel() {
    document.getElementById('level-screen').classList.add('hidden');
    currentLevel++;
    if (currentLevel > 3) {
        document.getElementById('victory-screen').classList.remove('hidden');
    } else {
        gameState = 'playing';
        initLevel(currentLevel);
    }
}

// Input Handling
window.addEventListener('keydown', e => {
    if(gameState !== 'playing') return;
    if(e.key === 'ArrowUp') { player.nextDirX = 0; player.nextDirY = -1; }
    if(e.key === 'ArrowDown') { player.nextDirX = 0; player.nextDirY = 1; }
    if(e.key === 'ArrowLeft') { player.nextDirX = -1; player.nextDirY = 0; }
    if(e.key === 'ArrowRight') { player.nextDirX = 1; player.nextDirY = 0; }
});

function handleTouch(dir) {
    if(gameState !== 'playing') return;
    if(dir === 'up') { player.nextDirX = 0; player.nextDirY = -1; }
    if(dir === 'down') { player.nextDirX = 0; player.nextDirY = 1; }
    if(dir === 'left') { player.nextDirX = -1; player.nextDirY = 0; }
    if(dir === 'right') { player.nextDirX = 1; player.nextDirY = 0; }
}

init();

</script>
</body>
</html>
