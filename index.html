<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary-orange: #FF8C42; 
        --primary-light: #FFAB91;
        --pastel-bg: #FFF3E0;
        --card-bg: #FFFFFF;
        --text-dark: #4A4A4A;
        --grey-pastel: #F5F5F5;
        --accent-green: #A5D6A7;
        --accent-red: #EF9A9A;
      }

      body { 
        font-family: 'Poppins', sans-serif; 
        background: linear-gradient(135deg, #FFF8E1 0%, #FFF3E0 100%); 
        display: flex; justify-content: center; padding: 40px; 
        color: var(--text-dark); margin: 0; min-height: 100vh;
      }
      
      .container { 
        background: var(--card-bg); 
        padding: 0; 
        border-radius: 20px; 
        box-shadow: 0 10px 30px rgba(255, 140, 66, 0.15); 
        width: 95%; max-width: 1400px; 
        text-align: center; overflow: hidden; position: relative;
      }
      
      /* TABS */
      .tabs { display: flex; background: #FAFAFA; padding: 10px 10px 0 10px; border-bottom: 1px solid #EEE; }
      .tab { 
        flex: 1; padding: 18px; cursor: pointer; font-weight: 600; color: #9E9E9E; 
        transition: all 0.3s; border-radius: 15px 15px 0 0; margin: 0 5px;
      }
      .tab:hover { background: #FFFBF5; color: var(--primary-orange); transform: translateY(-4px); }
      .tab.active { background: white; color: var(--primary-orange); box-shadow: 0 -5px 15px rgba(255, 140, 66, 0.1); z-index: 10; }

      .tab-content { display: none; padding: 40px; animation: fadeIn 0.5s; }
      .tab-content.active { display: block; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      h1 { color: var(--primary-orange); margin-bottom: 10px; font-weight: 700; letter-spacing: -0.5px; }
      p { color: #757575; margin-bottom: 30px; line-height: 1.6; }
      
      /* UPLOAD */
      .upload-grid { display: flex; gap: 25px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px; }
      .upload-area { 
        border: 2px dashed #E0E0E0; border-radius: 15px; padding: 30px; 
        background: #FAFAFA; cursor: pointer; transition: all 0.3s; 
        flex: 1; min-width: 280px; max-width: 450px; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
      }
      .upload-area:hover { border-color: var(--primary-orange); background: #FFF8E1; transform: translateY(-5px); }
      .upload-area.active { border-color: #81C784; background: #F1F8E9; transform: scale(1.02); }
      .upload-icon { font-size: 40px; color: var(--primary-light); margin-bottom: 15px; }
      .upload-label { font-weight: 600; margin-bottom: 8px; color: #555; }
      .file-name { font-size: 13px; color: #388E3C; font-weight: 600; margin-top: 8px; }
      input[type="file"] { display: none; }
      
      /* BUTTONS */
      .btn { 
        background: linear-gradient(135deg, #FF8C42 0%, #FF7043 100%); 
        color: white; border: none; padding: 15px 50px; border-radius: 50px; 
        cursor: pointer; font-size: 16px; font-weight: 600; 
        box-shadow: 0 4px 15px rgba(255, 112, 67, 0.3); transition: all 0.3s; margin-top: 10px;
      }
      .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(255, 112, 67, 0.4); }
      .btn:disabled { background: #E0E0E0; cursor: not-allowed; box-shadow: none; transform: none; color: #9E9E9E; }
      
      .download-btn { background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%); display: none; margin: 20px auto; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
      .download-btn:hover { box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4); }

      #status { margin-top: 25px; font-weight: 500; }
      .error-msg { color: #D32F2F; background: #FFEBEE; padding: 10px 20px; border-radius: 30px; display: inline-block; }
      .success-msg { color: #388E3C; background: #E8F5E9; padding: 10px 20px; border-radius: 30px; display: inline-block; }

      /* TABELLA */
      .table-wrapper { margin-top: 40px; overflow-x: auto; border: 1px solid #EEE; border-radius: 12px; max-height: 600px; display: none; }
      table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
      th { background-color: #FAFAFA; padding: 15px; position: sticky; top: 0; border-bottom: 2px solid #EEE; z-index: 10; white-space: nowrap; font-weight: 600; color: #616161; }
      td { padding: 12px 15px; border-bottom: 1px solid #F5F5F5; white-space: nowrap; max-width: 300px; overflow: hidden; text-overflow: ellipsis; }
      .cell-error { color: #D32F2F; background-color: #FFEBEE; font-weight: 500; border-radius: 6px; }
      .cell-action { color: #1565C0; background-color: #E3F2FD; font-weight: 500; border-radius: 6px; }
      .cell-ok { color: #388E3C; background-color: #E8F5E9; font-weight: 600; text-align: center; border-radius: 6px; }

      /* GUIDA CARDS */
      .guide-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; text-align: left; }
      .guide-card { 
        background: #FFF; border: 1px solid #EEE; border-radius: 15px; padding: 25px; 
        transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; position: relative;
      }
      .guide-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(255, 140, 66, 0.2); border-color: var(--primary-light); }
      .guide-card h3 { color: var(--primary-orange); margin-top: 0; font-size: 18px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
      .guide-card h3::after { content: '‚úâÔ∏è'; font-size: 16px; opacity: 0.5; }
      .guide-card p { font-size: 13px; margin-bottom: 0; color: #666; line-height: 1.5; }
      .guide-tag { display: inline-block; background: #FFF3E0; color: #E65100; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-bottom: 10px; }

      /* MODAL POPUP */
      .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000; display: none;
        align-items: center; justify-content: center; backdrop-filter: blur(3px);
      }
      .modal {
        background: white; width: 90%; max-width: 600px; padding: 30px;
        border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        position: relative; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-align: left;
      }
      @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
      .close-modal:hover { color: #333; }
      
      .email-box {
        background: #F9FAFB; border: 1px solid #EEE; border-radius: 10px;
        padding: 20px; margin-top: 15px; font-family: 'Courier New', monospace; font-size: 14px; color: #333;
        position: relative;
      }
      .copy-btn {
        position: absolute; top: 10px; right: 10px;
        background: white; border: 1px solid #DDD; padding: 5px 10px;
        border-radius: 6px; font-size: 12px; cursor: pointer; font-family: 'Poppins', sans-serif;
      }
      .copy-btn:hover { background: #EEE; }
      
    </style>
  </head>
  <body>
    <div class="container">
      
      <div class="tabs">
        <div class="tab active" onclick="switchTab('validator')">1. VALIDATORE</div>
        <div class="tab" onclick="switchTab('guide')">2. GUIDA & SOLUZIONI</div>
      </div>

      <!-- TAB 1: VALIDATORE -->
      <div id="validator" class="tab-content active">
        <h1>AMD Sustainability Validator</h1>
        <p>Carica il file AMD e il Report Invalidi per il controllo incrociato.</p>
        
        <div class="upload-grid">
          <div class="upload-area" id="area1" onclick="document.getElementById('fileAmd').click()">
            <div class="upload-label">1. File AMD (Articoli)</div>
            <div class="upload-icon">üìÑ</div>
            <div style="font-size: 12px; color: #999;">Trascina o clicca per caricare .csv</div>
            <div id="nameAmd" class="file-name"></div>
          </div>
          <input type="file" id="fileAmd" accept=".csv" onchange="fileSelected('fileAmd', 'nameAmd', 'area1')">

          <div class="upload-area" id="area2" onclick="document.getElementById('fileReport').click()">
            <div class="upload-label">2. Report Invalidi (Opzionale)</div>
            <div class="upload-icon">‚ö†Ô∏è</div>
            <div style="font-size: 12px; color: #999;">Carica per vedere gli errori ufficiali</div>
            <div id="nameReport" class="file-name"></div>
          </div>
          <input type="file" id="fileReport" accept=".csv" onchange="fileSelected('fileReport', 'nameReport', 'area2')">
        </div>

        <button id="processBtn" class="btn" onclick="processFiles()">Avvia Analisi</button>
        <button id="downloadBtn" class="btn download-btn" onclick="downloadCSV()">Scarica Report</button>
        
        <div id="status"></div>
        <div id="previewContainer" class="table-wrapper"><table id="resultTable"></table></div>
      </div>

      <!-- TAB 2: GUIDA CON POPUP -->
      <div id="guide" class="tab-content">
        <h1>Guida & Template Email</h1>
        <p>Clicca su un errore per generare una email per il fornitore.</p>

        <div class="guide-grid">
          
          <div class="guide-card" onclick="openModal('A')">
            <span class="guide-tag">ISSUE A</span>
            <h3>Certificate Not Valid</h3>
            <p>This certificate is now retired.</p>
          </div>

          <div class="guide-card" onclick="openModal('B')">
            <span class="guide-tag">ISSUE B</span>
            <h3>Claim Missing Data Points</h3>
            <p>Not all data points have been provided.</p>
          </div>

          <div class="guide-card" onclick="openModal('C')">
            <span class="guide-tag">ISSUE C</span>
            <h3>Component Not Eligible</h3>
            <p>The component claim made is not eligible.</p>
          </div>

          <div class="guide-card" onclick="openModal('D')">
            <span class="guide-tag">ISSUE D</span>
            <h3>Tier Not Met</h3>
            <p>Certification level does not meet minimum requirements.</p>
          </div>

          <div class="guide-card" onclick="openModal('E')">
            <span class="guide-tag">ISSUE E</span>
            <h3>Percentage Not Met</h3>
            <p>Percentage does not meet minimum requirements.</p>
          </div>

          <div class="guide-card" onclick="openModal('F')">
            <span class="guide-tag">ISSUE F</span>
            <h3>Other Issues</h3>
            <p>General data inconsistency.</p>
          </div>

          <div class="guide-card" onclick="openModal('G')">
            <span class="guide-tag">ISSUE G</span>
            <h3>Multiple Data Issues</h3>
            <p>Multiple inconsistencies found.</p>
          </div>

        </div>
      </div>
    </div>

    <!-- MODAL POPUP -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
      <div class="modal">
        <span class="close-modal" onclick="closeModalButton()">&times;</span>
        <h2 id="modalTitle" style="color: var(--primary-orange); margin-top: 0;">Template Email</h2>
        <p id="modalDesc">Copia questo testo e invialo al supplier.</p>
        
        <div class="email-box">
          <button class="copy-btn" onclick="copyEmail()">Copia Testo</button>
          <div id="emailContent"></div>
        </div>
      </div>
    </div>

    <script>
      // --- LOGICA TEMPLATE EMAIL (UFFICIALE DA INTRO.CSV) ---
      const templates = {
        'A': {
          title: "Issue A: Certificate not valid",
          desc: "This certificate is now retired.",
          subject: "Subject: Urgent: Invalid Sustainability Certificate for [Insert SKU]",
          body: "Dear Supplier,\n\nFor the article [Insert SKU], the certificate provided is now retired or not valid.\n\nPlease select a new valid certification and provide relevant data points based on the certification.\n\nThank you."
        },
        'B': {
          title: "Issue B: Claim missing data points",
          desc: "Not all data points have been provided.",
          subject: "Subject: Missing Sustainability Data for [Insert SKU]",
          body: "Dear Supplier,\n\nNot all data points have been provided in order to be awarded a sustainability benefit for a generic claim for article [Insert SKU].\n\nPlease provide required data points based on the certification (e.g. Percentage, Component, Level).\n\nThank you."
        },
        'C': {
          title: "Issue C: Component not eligible",
          desc: "The component claim made is not eligible.",
          subject: "Subject: Ineligible Component Claim for [Insert SKU]",
          body: "Dear Supplier,\n\nThe component claim made for article [Insert SKU] is not eligible for the product and/or certificate selected.\n\nPlease revise the component / full-product stated accordingly. If component, please choose the right component for the product type (CG3).\n\nThank you."
        },
        'D': {
          title: "Issue D: Certification tier not met",
          desc: "The certification level stated does not meet minimum requirements.",
          subject: "Subject: Certification Level Requirements for [Insert SKU]",
          body: "Dear Supplier,\n\nThe certification level stated for article [Insert SKU] does not meet minimum requirements for a generic claim.\n\nPlease confirm the certification level with the brand and explain the ranking of certification levels (brand level > assembly factory > material fabrication > material processing > raw material extraction).\n\nThank you."
        },
        'E': {
          title: "Issue E: Percentage not met",
          desc: "The percentage does not meet minimum requirements.",
          subject: "Subject: Insufficient Certified Material Percentage for [Insert SKU]",
          body: "Dear Supplier,\n\nThe percentage of certified material stated for article [Insert SKU] does not meet minimum requirements.\n\nPlease confirm the percentage with the brand.\n\nThank you."
        },
        'F': {
          title: "Issue F: Other issues",
          desc: "General data inconsistency.",
          subject: "Subject: Sustainability Data Issues for [Insert SKU]",
          body: "Dear Supplier,\n\nWe have identified issues with the sustainability data for article [Insert SKU].\n\nPlease check the comments column for more details and revise the data accordingly.\n\nThank you."
        },
        'G': {
          title: "Issue G: Multiple data issues",
          desc: "Multiple data points are incorrect.",
          subject: "Subject: Multiple Sustainability Data Errors for [Insert SKU]",
          body: "Dear Supplier,\n\nArticle [Insert SKU] has multiple data issues preventing the sustainability claim from being accepted.\n\nPlease review all data points provided for this article.\n\nThank you."
        }
      };

      function openModal(issueType) {
        const data = templates[issueType];
        if(!data) return;
        
        document.getElementById('modalTitle').textContent = data.title;
        document.getElementById('modalDesc').textContent = data.desc;
        
        const htmlContent = `<strong>${data.subject}</strong><br><br>${data.body.replace(/\n/g, '<br>')}`;
        document.getElementById('emailContent').innerHTML = htmlContent;
        
        document.getElementById('modalOverlay').style.display = 'flex';
      }

      function closeModal(e) {
        if (e.target.id === 'modalOverlay') document.getElementById('modalOverlay').style.display = 'none';
      }
      function closeModalButton() {
        document.getElementById('modalOverlay').style.display = 'none';
      }

      function copyEmail() {
        const content = document.getElementById('emailContent').innerText;
        navigator.clipboard.writeText(content).then(() => {
          const btn = document.querySelector('.copy-btn');
          btn.textContent = "Copiato!";
          setTimeout(() => btn.textContent = "Copia Testo", 2000);
        });
      }

      // --- LOGICA VALIDATORE ---
      let processedData = [];
      let fileAmdObj = null; let fileReportObj = null;

      function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
      }

      function fileSelected(inputId, nameId, areaId) {
        const input = document.getElementById(inputId);
        if (input.files.length > 0) {
          const f = input.files[0];
          document.getElementById(nameId).textContent = f.name;
          document.getElementById(areaId).classList.add('active');
          if(inputId === 'fileAmd') fileAmdObj = f;
          if(inputId === 'fileReport') fileReportObj = f;
          document.getElementById('status').textContent = "";
        }
      }

      function processFiles() {
        if (!fileAmdObj) { alert("Devi caricare almeno il file AMD!"); return; }
        const btn = document.getElementById('processBtn');
        const status = document.getElementById('status');
        btn.disabled = true; btn.textContent = "Elaborazione..."; status.innerHTML = "";

        const readerAmd = new FileReader();
        readerAmd.onload = function(eAmd) {
          const amdContent = eAmd.target.result;
          if (fileReportObj) {
            const readerRep = new FileReader();
            readerRep.onload = function(eRep) { sendToScript(amdContent, eRep.target.result); };
            readerRep.readAsText(fileReportObj);
          } else {
            sendToScript(amdContent, null);
          }
        };
        readerAmd.readAsText(fileAmdObj);
      }

      function sendToScript(amdData, reportData) {
        google.script.run
          .withSuccessHandler(function(result) {
            processedData = result;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('processBtn').textContent = "Avvia Analisi";
            document.getElementById('processBtn').style.display = "none";
            
            let errorCount = 0;
            const reportIdx = result[0].indexOf("VALIDATION REPORT"); 
            for(let i=1; i<result.length; i++) { if(result[i][reportIdx] !== "OK") errorCount++; }

            const status = document.getElementById('status');
            if(errorCount > 0) status.innerHTML = "<span class='error-msg'>‚ö†Ô∏è Trovati " + errorCount + " errori. Vedi anteprima sotto.</span>";
            else status.innerHTML = "<span class='success-msg'>‚úÖ Tutto perfetto!</span>";
            
            document.getElementById('downloadBtn').style.display = "inline-block";
            renderTable(result, reportIdx);
          })
          .withFailureHandler(function(err) {
            document.getElementById('processBtn').disabled = false;
            document.getElementById('status').textContent = "Errore: " + err.message;
          })
          .processData(amdData, reportData);
      }

      function renderTable(data, reportIdx) {
        const container = document.getElementById('previewContainer');
        const table = document.getElementById('resultTable');
        table.innerHTML = ""; 
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const actionIdx = data[0].indexOf("Suggested Action");

        data[0].forEach(text => {
          const th = document.createElement('th'); th.textContent = text; headerRow.appendChild(th);
        });
        thead.appendChild(headerRow); table.appendChild(thead);

        const tbody = document.createElement('tbody');
        const maxRows = Math.min(data.length, 100); 
        for (let i = 1; i < maxRows; i++) {
          const tr = document.createElement('tr');
          data[i].forEach((text, colIndex) => {
            const td = document.createElement('td'); td.textContent = text;
            if (colIndex === reportIdx && text !== "OK") td.className = "cell-error";
            if (colIndex === actionIdx && text !== "") td.className = "cell-action";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        container.style.display = "block";
      }

      function downloadCSV() {
        if (!processedData || processedData.length === 0) return;
        let csvContent = "";
        processedData.forEach(function(rowArray) {
          let row = rowArray.map(item => {
            let str = String(item);
            if (str.includes(";") || str.includes("\n")) return `"${str.replace(/"/g, '""')}"`; 
            return str;
          }).join(";");
          csvContent += row + "\r\n";
        });
        var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement("a");
        var url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "Report_Validator.csv");
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
      }
    </script>
  </body>
</html>
