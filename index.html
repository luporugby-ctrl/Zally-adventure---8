<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZAC-MAN: Operations Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --zalando-orange: #ff6900;
            --zalando-black: #1a1a1a;
            --neon-blue: #00ffff;
            --text-main: #ffffff;
            --sidebar-bg: #222;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--zalando-black);
            color: var(--text-main);
            font-family: 'Roboto', sans-serif; /* Font leggibile per le istruzioni */
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        #main-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* SIDEBAR (ISTRUZIONI & INFO) */
        #sidebar {
            width: 350px;
            background-color: var(--sidebar-bg);
            border-right: 4px solid var(--zalando-orange);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            z-index: 100;
        }

        #game-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #000;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* TYPOGRAPHY SIDEBAR */
        h1 {
            font-family: 'Press Start 2P', cursive;
            color: var(--zalando-orange);
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px #000;
        }
        .subtitle {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: #888;
            margin-bottom: 20px;
        }

        h2 { font-size: 1.1rem; color: var(--neon-blue); margin-top: 20px; border-bottom: 1px solid #444; padding-bottom: 5px;}
        p, li { font-size: 0.9rem; line-height: 1.5; color: #ddd; margin-bottom: 10px; }
        strong { color: white; }
        
        .info-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--zalando-orange);
            margin-bottom: 15px;
        }

        .controls-nav {
            margin-top: auto;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 10px 15px;
            cursor: pointer;
            font-family: 'Press Start 2P';
            font-size: 0.6rem;
            flex-grow: 1;
            transition: all 0.2s;
        }
        button:hover { background: var(--zalando-orange); color: black; border-color: var(--zalando-orange); }
        button.primary { background: var(--zalando-orange); color: black; border-color: var(--zalando-orange); }

        /* ARCADE CABINET STYLE */
        #arcade-screen {
            position: relative;
            border: 10px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 105, 0, 0.3);
            background: black;
            overflow: hidden;
        }

        canvas { display: block; }

        /* GAME OVERLAYS */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 10;
        }
        .hidden { display: none !important; }

        .pixel-font { font-family: 'Press Start 2P', cursive; }
        
        .overlay h2 { font-size: 1.5rem; color: var(--neon-blue); margin-bottom: 10px; border: none; }
        .overlay p { font-family: 'Press Start 2P', cursive; font-size: 0.7rem; color: #ccc; max-width: 80%; line-height: 1.6; }

        /* RESPONSIVE */
        @media (max-width: 800px) {
            #main-wrapper { flex-direction: column-reverse; }
            #sidebar { width: 100%; height: 40%; border-right: none; border-top: 4px solid var(--zalando-orange); }
            #game-area { height: 60%; }
        }

        /* MOBILE CONTROLS */
        #mobile-controls {
            position: absolute; bottom: 20px; right: 20px;
            display: none; flex-direction: column; align-items: center; gap: 10px; z-index: 50;
        }
        .d-row { display: flex; gap: 60px; }
        .d-btn {
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; user-select: none;
        }
        .d-btn:active { background: var(--zalando-orange); }

    </style>
</head>
<body>

<div id="main-wrapper">
    
    <!-- SIDEBAR: INFORMAZIONI E CONTROLLI -->
    <div id="sidebar">
        <h1>ZAC-MAN</h1>
        <div class="subtitle">OPERATIONS EDITION</div>

        <!-- SEZIONE 1: COS'√à NOTEBOOKLM -->
        <div class="info-box">
            <h2>Cos'√® NotebookLM?</h2>
            <p><strong>Attenzione:</strong> Non √® un'estensione dentro Gmail o Drive. √à una Web App indipendente.</p>
            <p>√à il tuo <strong>Research Assistant</strong> personale. Tu carichi i documenti (PDF, Slide, Link) e lui diventa un esperto istantaneo su quei contenuti.</p>
            <p style="font-size:0.75rem; color:#aaa;">üåê notebooklm.google.com</p>
        </div>

        <!-- SEZIONE 2: MISSIONE -->
        <div class="info-box">
            <h2>La Tua Missione</h2>
            <p>Il Labirinto Ops √® pieno di documenti (i Fantasmi).</p>
            <ul>
                <li>Usa le <strong>Frecce</strong> per guidare Zally.</li>
                <li>Mangia le <strong>Fonti</strong> (PDF, Doc, Web) per caricarle.</li>
                <li>Completa i 4 livelli per sbloccare le funzionalit√†.</li>
            </ul>
        </div>

        <!-- NAVIGAZIONE -->
        <div class="controls-nav">
            <button onclick="prevLevel()">‚óÄ Indietro</button>
            <button onclick="resetGame()">Riavvia ‚ü≥</button>
            <div style="width:100%; height:10px;"></div>
            <button class="primary" onclick="window.open('https://notebooklm.google.com', '_blank')">Apri NotebookLM ‚Üó</button>
        </div>
    </div>

    <!-- AREA GIOCO -->
    <div id="game-area">
        <div id="arcade-screen">
            <canvas id="gameCanvas" width="600" height="600"></canvas>
            
            <!-- START SCREEN -->
            <div id="start-screen" class="overlay">
                <h2 class="pixel-font" style="color:var(--zalando-orange);">START GAME</h2>
                <div style="margin:20px;">
                     <!-- Zally Placeholder -->
                     <img src="zally.png" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iI2ZmNjkwMCIvPjwvc3ZnPg=='" style="width: 80px; height: 80px; animation: bounce 1s infinite alternate;">
                </div>
                <p>Premi START per iniziare l'apprendimento.</p>
                <button class="primary" onclick="startGame()">START</button>
            </div>

            <!-- LEVEL COMPLETE SCREEN -->
            <div id="level-screen" class="overlay hidden">
                <h2 class="pixel-font" id="level-title">LEVEL CLEARED!</h2>
                <p id="level-msg">...</p>
                <div style="border: 2px dashed white; padding: 15px; margin: 15px 0; background: #222;">
                    <p id="level-lesson" style="color: #00ffff;">...</p>
                </div>
                <button class="primary" onclick="nextLevel()">NEXT FEATURE >></button>
            </div>

            <!-- VICTORY SCREEN -->
            <div id="victory-screen" class="overlay hidden">
                <h2 class="pixel-font" style="color: var(--zalando-orange);">COMPLIMENTI!</h2>
                <p>Hai domato il caos operativo.</p>
                <p>Ora sai che NotebookLM serve per:<br>1. Centralizzare le fonti<br>2. Sintetizzare<br>3. Verificare (Grounding)</p>
                <button class="primary" onclick="resetGame()">GIOCA ANCORA</button>
            </div>

            <!-- TOUCH CONTROLS -->
            <div id="mobile-controls">
                <div class="d-btn" ontouchstart="handleTouch('up')">‚ñ≤</div>
                <div class="d-row">
                    <div class="d-btn" ontouchstart="handleTouch('left')">‚óÄ</div>
                    <div class="d-btn" ontouchstart="handleTouch('right')">‚ñ∂</div>
                </div>
                <div class="d-btn" ontouchstart="handleTouch('down')">‚ñº</div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ZAC-MAN ENGINE - UPDATED
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let animationId;

// --- CONFIG ---
const COLS = 20;
const ROWS = 20;
let tileSize = 30; // Will be dynamic

// --- STATE ---
let gameState = 'start'; 
let currentLevel = 1;
let ghosts = [];
let player = { x: 1, y: 1, dirX: 0, dirY: 0, nextDirX: 0, nextDirY: 0, speed: 0.15, angle: 0 };

// --- MAPPA (1=Muro, 0=Vuoto) ---
const mapDesign = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,1,0,1,1,0,1,0,1,1,0,1,1,1,0,0,1],
    [1,0,1,1,1,0,1,1,0,1,0,1,1,0,1,1,1,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,0,1,1,1,1,1,1,0,1,0,1,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,0,0,0,1],
    [1,1,1,1,0,1,1,1,0,1,0,1,1,1,1,0,1,1,1,1],
    [1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,1],
    [1,0,1,1,0,1,0,1,1,0,0,1,0,1,0,1,1,0,0,1], 
    [1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,0,1,0,1,1,1,1,1,1,0,1,0,1,1,0,1],
    [1,0,0,1,0,1,0,0,0,1,0,0,0,0,1,0,1,0,0,1],
    [1,1,0,1,0,1,1,1,0,1,0,1,1,1,1,0,1,0,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,1,0,1,1,0,1,0,1,1,0,1,1,1,0,0,1],
    [1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],
    [1,1,1,0,1,0,1,1,1,1,1,1,1,0,1,0,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const GHOST_TYPES = [
    { name: "PDF", color: "#e74c3c", label: "PDF" },
    { name: "DOC", color: "#3498db", label: "DOC" },
    { name: "WEB", color: "#2ecc71", label: "WEB" },
    { name: "MAIL", color: "#f1c40f", label: "@" }
];

// --- INIT ---
function init() {
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    requestAnimationFrame(gameLoop);
    
    // Check mobile
    if('ontouchstart' in window) {
        document.getElementById('mobile-controls').style.display = 'flex';
    }
}

function resizeCanvas() {
    // Adatta il canvas allo spazio disponibile
    const container = document.getElementById('arcade-screen');
    const size = Math.min(container.clientWidth, container.clientHeight - 20); // -20 padding
    // Mantieni aspect ratio quadrato
    //canvas.style.width = size + 'px';
    //canvas.style.height = size + 'px';
    //tileSize = canvas.width / COLS;
    // (Simplification for CSS sizing)
}

function initLevel(level) {
    player.x = 1; player.y = 1;
    player.dirX = 0; player.dirY = 0;
    player.nextDirX = 0; player.nextDirY = 0;

    ghosts = [];
    let count = 2 + level; 
    
    for (let i = 0; i < count; i++) {
        spawnGhost(i);
    }
}

function spawnGhost(index) {
    let placed = false;
    while (!placed) {
        let rx = Math.floor(Math.random() * COLS);
        let ry = Math.floor(Math.random() * ROWS);
        if (mapDesign[ry][rx] === 0 && (Math.abs(rx - player.x) > 6)) {
            let type = GHOST_TYPES[index % GHOST_TYPES.length];
            // Random direction start
            let dirs = [{x:1,y:0}, {x:-1,y:0}, {x:0,y:1}, {x:0,y:-1}];
            let startDir = dirs[Math.floor(Math.random()*4)];
            
            ghosts.push({
                x: rx, 
                y: ry, 
                type: type,
                dirX: startDir.x,
                dirY: startDir.y,
                speed: 0.08, // Velocit√† costante per movimento fluido
                lastMoveTime: 0
            });
            placed = true;
        }
    }
}

// --- LOGIC ---
function isWall(x, y) {
    if (y < 0 || y >= ROWS || x < 0 || x >= COLS) return true;
    return mapDesign[Math.floor(y)][Math.floor(x)] === 1;
}

function update() {
    if (gameState !== 'playing') return;

    // 1. PLAYER MOVEMENT (Grid Based)
    const centerX = Math.floor(player.x + 0.5);
    const centerY = Math.floor(player.y + 0.5);
    const dist = Math.abs(player.x - centerX) + Math.abs(player.y - centerY);

    // Turn logic
    if (dist < 0.15) { 
        if (player.nextDirX !== 0 || player.nextDirY !== 0) {
            if (!isWall(centerX + player.nextDirX, centerY + player.nextDirY)) {
                player.x = centerX; player.y = centerY;
                player.dirX = player.nextDirX; player.dirY = player.nextDirY;
                player.nextDirX = 0; player.nextDirY = 0;
            }
        }
        if (isWall(centerX + player.dirX, centerY + player.dirY)) {
            player.dirX = 0; player.dirY = 0;
        }
    }
    player.x += player.dirX * player.speed;
    player.y += player.dirY * player.speed;
    
    // Angle for drawing
    if (player.dirX === 1) player.angle = 0;
    if (player.dirX === -1) player.angle = Math.PI;
    if (player.dirY === -1) player.angle = -Math.PI/2;
    if (player.dirY === 1) player.angle = Math.PI/2;

    // 2. GHOST AI MOVEMENT (Patrolling)
    ghosts.forEach(ghost => {
        const gx = Math.floor(ghost.x + 0.5);
        const gy = Math.floor(ghost.y + 0.5);
        const gDist = Math.abs(ghost.x - gx) + Math.abs(ghost.y - gy);

        // Se √® al centro di una tile
        if (gDist < 0.1) {
            ghost.x = gx; ghost.y = gy;
            
            // Check avanti
            let nextX = Math.round(ghost.x + ghost.dirX);
            let nextY = Math.round(ghost.y + ghost.dirY);
            
            // Se c'√® un muro davanti o random (10% change) in un incrocio
            if (isWall(nextX, nextY) || Math.random() < 0.1) {
                // Trova direzioni valide
                let possible = [];
                if (!isWall(gx+1, gy)) possible.push({x:1, y:0});
                if (!isWall(gx-1, gy)) possible.push({x:-1, y:0});
                if (!isWall(gx, gy+1)) possible.push({x:0, y:1});
                if (!isWall(gx, gy-1)) possible.push({x:0, y:-1});
                
                // Rimuovi inversione a U se ci sono alternative
                let forward = possible.filter(d => !(d.x === -ghost.dirX && d.y === -ghost.dirY));
                
                if (forward.length > 0) {
                    let pick = forward[Math.floor(Math.random() * forward.length)];
                    ghost.dirX = pick.x; ghost.dirY = pick.y;
                } else if (possible.length > 0) {
                    // Cul de sac, torna indietro
                    let pick = possible[0];
                    ghost.dirX = pick.x; ghost.dirY = pick.y;
                }
            }
        }
        
        ghost.x += ghost.dirX * ghost.speed;
        ghost.y += ghost.dirY * ghost.speed;
    });

    // 3. EATING LOGIC
    for (let i = ghosts.length - 1; i >= 0; i--) {
        const g = ghosts[i];
        const dx = player.x - g.x;
        const dy = player.y - g.y;
        if (Math.sqrt(dx*dx + dy*dy) < 0.8) {
            ghosts.splice(i, 1);
        }
    }

    if (ghosts.length === 0) endLevel();
}

// --- DRAW ---
function draw() {
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    const ts = canvas.width / COLS;

    // Map
    ctx.fillStyle = "#2c3e50";
    for (let y=0; y<ROWS; y++) {
        for (let x=0; x<COLS; x++) {
            if (mapDesign[y][x] === 1) {
                ctx.fillStyle = "#333";
                ctx.fillRect(x*ts, y*ts, ts, ts);
                ctx.strokeStyle = "var(--zalando-orange)";
                ctx.lineWidth = 1;
                ctx.strokeRect(x*ts+4, y*ts+4, ts-8, ts-8);
            }
        }
    }

    // Ghosts
    ghosts.forEach(g => {
        let gx = g.x * ts + ts/2;
        let gy = g.y * ts + ts/2;
        ctx.fillStyle = g.type.color;
        ctx.beginPath();
        ctx.arc(gx, gy-2, ts*0.4, Math.PI, 0, false);
        ctx.lineTo(gx+ts*0.4, gy+ts*0.4);
        ctx.lineTo(gx-ts*0.4, gy+ts*0.4);
        ctx.fill();
        ctx.fillStyle = "black";
        ctx.font = "bold 10px Arial";
        ctx.textAlign = "center";
        ctx.fillText(g.type.label, gx, gy+4);
    });

    // Player
    let px = player.x * ts + ts/2;
    let py = player.y * ts + ts/2;
    ctx.save();
    ctx.translate(px, py);
    ctx.rotate(player.angle);
    ctx.fillStyle = "#ff6900";
    ctx.beginPath();
    let mouth = Math.abs(Math.sin(Date.now()/100)) * 0.2 + 0.05;
    ctx.arc(0, 0, ts*0.45, mouth*Math.PI, (2-mouth)*Math.PI);
    ctx.lineTo(0,0);
    ctx.fill();
    ctx.restore();
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// --- CONTROLS & UI FUNC ---
function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    currentLevel = 1;
    gameState = 'playing';
    initLevel(1);
}

function resetGame() {
    document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    document.getElementById('start-screen').classList.remove('hidden');
    gameState = 'start';
}

function prevLevel() {
    if (currentLevel > 1) {
        currentLevel--;
        document.getElementById('level-screen').classList.add('hidden');
        document.getElementById('victory-screen').classList.add('hidden');
        gameState = 'playing';
        initLevel(currentLevel);
    } else {
        resetGame();
    }
}

function endLevel() {
    gameState = 'level_transition';
    const screen = document.getElementById('level-screen');
    const title = document.getElementById('level-title');
    const msg = document.getElementById('level-msg');
    const lesson = document.getElementById('level-lesson');

    screen.classList.remove('hidden');

    if (currentLevel === 1) {
        title.innerHTML = "FONTI CARICATE!";
        msg.innerHTML = "Hai centralizzato la conoscenza.";
        lesson.innerHTML = "<strong>FEATURE: SORGENTI MULTIMODALI</strong><br>Invece di avere 10 tab aperti (Drive, Slide, PDF), caricali tutti su NotebookLM. Diventa la tua 'Single Source of Truth'.";
    } else if (currentLevel === 2) {
        title.innerHTML = "SINTESI FATTA!";
        msg.innerHTML = "Hai ridotto il rumore di fondo.";
        lesson.innerHTML = "<strong>FEATURE: SOMMARIO & KEY TOPICS</strong><br>NotebookLM legge istantaneamente documenti di 50 pagine e ti dice cosa conta. Ottimo per Onboarding e nuove Policy.";
    } else if (currentLevel === 3) {
        title.innerHTML = "GROUNDING OK!";
        msg.innerHTML = "Niente allucinazioni, solo fatti.";
        lesson.innerHTML = "<strong>FEATURE: CITAZIONI IN-LINE</strong><br>Ogni risposta ha un link [1] che ti porta alla riga esatta del documento originale. Fiducia totale nel dato.";
    }
}

function nextLevel() {
    document.getElementById('level-screen').classList.add('hidden');
    currentLevel++;
    if (currentLevel > 3) {
        document.getElementById('victory-screen').classList.remove('hidden');
    } else {
        gameState = 'playing';
        initLevel(currentLevel);
    }
}

// Keyboard
window.addEventListener('keydown', e => {
    if(gameState !== 'playing') return;
    if(e.key === 'ArrowUp') { player.nextDirX = 0; player.nextDirY = -1; }
    if(e.key === 'ArrowDown') { player.nextDirX = 0; player.nextDirY = 1; }
    if(e.key === 'ArrowLeft') { player.nextDirX = -1; player.nextDirY = 0; }
    if(e.key === 'ArrowRight') { player.nextDirX = 1; player.nextDirY = 0; }
});

// Touch
function handleTouch(dir) {
    if(gameState !== 'playing') return;
    if(dir === 'up') { player.nextDirX = 0; player.nextDirY = -1; }
    if(dir === 'down') { player.nextDirX = 0; player.nextDirY = 1; }
    if(dir === 'left') { player.nextDirX = -1; player.nextDirY = 0; }
    if(dir === 'right') { player.nextDirX = 1; player.nextDirY = 0; }
}

init();

</script>
</body>
</html>
